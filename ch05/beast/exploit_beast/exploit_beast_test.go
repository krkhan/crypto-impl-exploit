package exploit_beast

import (
	"testing"

	"github.com/krkhan/crypto-impl-exploit/ch05/beast/impl_beast"
)

func TestEncryptedHTTPSession(t *testing.T) {
	host := "bank.com"
	recoveredSessionId, err := RecoverSessionIDFromEncryptedHTTPSession(host)
	if err != nil {
		t.Fatalf("error performing BEAST attack: %s", err)
	}

	t.Logf("recoveredSessionId: %s\n", recoveredSessionId)

	if !impl_beast.ValidateSessionId(host, recoveredSessionId) {
		t.Fatalf("recoveredSessionId is incorrect, does not match the one stored for host %s", host)
	}
	t.Logf("recoveredSessionId verified successfully against host %s", host)

	differentHost := "someotherhost.com"
	_, _, _ = impl_beast.NewEncryptedHTTPSession(differentHost, "/")
	if impl_beast.ValidateSessionId(differentHost, recoveredSessionId) {
		t.Fatalf("recoveredSessionId is incorrectly valid for a different host")
	}
	t.Logf("recoveredSessionId is correctly invalid for a different host")
}
