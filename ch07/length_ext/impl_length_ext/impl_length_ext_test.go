package impl_length_ext

import (
	"strconv"
	"testing"
)

func TestBank(t *testing.T) {
	bank := NewBank()

	req, clientId, clientSecret, err := bank.NewClient("johndoe")
	if err != nil {
		t.Fatalf("error creating client: %s", err)
	}
	t.Logf("request url: %s", req.URL)

	req, balance, err := bank.CheckBalance(clientId, clientSecret)
	if err != nil {
		t.Fatalf("error getting balance: %s", err)
	}
	t.Logf("request url: %s", req.URL)
	t.Logf("balance: %s", balance)

	startingBalance, _ := strconv.ParseInt(balance, 10, 32)
	transactionAmount := 42

	req, oldBalance, newBalance, err := bank.Transaction(clientId, clientSecret, int64(transactionAmount))
	if err != nil {
		t.Fatalf("error exeucting transaction: %s", err)
	}
	t.Logf("request url: %s", req.URL)
	t.Logf("old balance: %s", oldBalance)
	t.Logf("new balance: %s", newBalance)

	req, balance, err = bank.CheckBalance(clientId, clientSecret)
	if err != nil {
		t.Fatalf("error getting balance: %s", err)
	}
	t.Logf("request url: %s", req.URL)
	t.Logf("balance: %s", balance)

	endingBalance, _ := strconv.ParseInt(balance, 10, 32)

	if endingBalance-startingBalance != int64(transactionAmount) {
		t.Fatalf("wrong balance after transaction, starting: %d, ending: %d, amount: %d",
			startingBalance, endingBalance, transactionAmount)
	}
}
